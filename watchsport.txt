(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "angers sco": "angers sco",
  "arsenal": "arsenal",
  "atlanta hawks": "atlanta hawks",
  "austin": "austin",
  "bayern münchen": "bayern münchen",
  "boston celtics": "boston celtics",
  "brighton": "brighton",
  "brooklyn nets": "brooklyn nets",
  "ceará": "ceará",
  "chelsea": "chelsea",
  "cleveland cavaliers": "cleveland cavaliers",
  "crystal palace": "crystal palace",
  "detroit pistons": "detroit pistons",
  "fiorentina": "fiorentina",
  "flamengo": "flamengo",
  "fluminense": "fluminense",
  "formula 1 - mexico city grand prix": "formula 1 - mexico city grand prix",
  "golden state warriors": "golden state warriors",
  "houston rockets": "houston rockets",
  "inter milan": "inter milan",
  "juventus": "juventus",
  "kansas city chiefs": "kansas city chiefs",
  "köln": "köln",
  "lens": "lens",
  "lille": "lille",
  "liverpool": "liverpool",
  "lorient": "lorient",
  "los angeles clippers": "los angeles clippers",
  "los angeles dodgers": "los angeles dodgers",
  "los angeles fc": "los angeles fc",
  "lyon": "lyon",
  "mallorca": "mallorca",
  "manchester city": "manchester city",
  "marseille": "marseille",
  "metz": "metz",
  "monaco": "monaco",
  "nantes": "nantes",
  "nascar cup series - xfinity 500": "nascar cup series - xfinity 500",
  "newcastle": "newcastle",
  "nice": "nice",
  "orlando magic": "orlando magic",
  "paris": "paris",
  "parma": "parma",
  "psg": "psg",
  "racing club": "racing club",
  "rayo vallecano": "rayo vallecano",
  "roma": "roma",
  "sant just": "sant just",
  "swansea city": "swansea city",
  "toronto blue jays": "toronto blue jays",
  "toronto raptors": "toronto raptors",
  "tottenham": "tottenham",
  "udinese": "udinese",
  "washington commanders": "washington commanders",
  "wolves": "wolves",
  "wwe nxt": "wwe nxt",
  "yuncos": "yuncos",
  "hawks": "atlanta hawks",
  "celtics": "boston celtics",
  "cavaliers": "cleveland cavaliers",
  "pistons": "detroit pistons",
  "warriors": "golden state warriors",
  "rockets": "houston rockets",
  "clippers": "los angeles clippers",
  "magic": "orlando magic",
  "raptors": "toronto raptors"
};

  const roxieStreamsCached = [
  {title: "juventus vs udinese", url: "https://roxiestreams.cc/soccer-streams-1"},
  {title: "parma vs roma", url: "https://roxiestreams.cc/soccer-streams-2"},
  {title: "lille vs nice", url: "https://roxiestreams.cc/soccer-streams-3"},
  {title: "lorient vs psg", url: "https://roxiestreams.cc/soccer-streams-4"},
  {title: "lens vs metz", url: "https://roxiestreams.cc/soccer-streams-5"},
  {title: "mallorca vs sant just", url: "https://roxiestreams.cc/soccer-streams-6"},
  {title: "bayern münchen vs köln", url: "https://roxiestreams.cc/soccer-streams-7"},
  {title: "arsenal vs brighton", url: "https://roxiestreams.cc/soccer-streams-8"},
  {title: "crystal palace vs liverpool", url: "https://roxiestreams.cc/soccer-streams-9"},
  {title: "chelsea vs wolves", url: "https://roxiestreams.cc/soccer-streams-10"},
  {title: "manchester city vs swansea city", url: "https://roxiestreams.cc/soccer-streams-11"},
  {title: "fiorentina vs inter milan", url: "https://roxiestreams.cc/soccer-streams-12"},
  {title: "rayo vallecano vs yuncos", url: "https://roxiestreams.cc/soccer-streams-13"},
  {title: "newcastle vs tottenham", url: "https://roxiestreams.cc/soccer-streams-14"},
  {title: "monaco vs nantes", url: "https://roxiestreams.cc/soccer-streams-3"},
  {title: "lyon vs paris", url: "https://roxiestreams.cc/soccer-streams-5"},
  {title: "angers sco vs marseille", url: "https://roxiestreams.cc/soccer-streams-4"},
  {title: "ceará vs fluminense", url: "https://roxiestreams.cc/soccer-streams-15"},
  {title: "flamengo vs racing club", url: "https://roxiestreams.cc/soccer-streams-16"},
  {title: "austin vs los angeles fc", url: "https://roxiestreams.cc/soccer-streams-17"},
  {title: "los angeles dodgers vs toronto blue jays", url: "https://roxiestreams.cc/mlb-streams-1"},
  {title: "houston rockets vs toronto raptors", url: "https://roxiestreams.cc/nba-streams-1"},
  {title: "detroit pistons vs orlando magic", url: "https://roxiestreams.cc/nba-streams-2"},
  {title: "boston celtics vs cleveland cavaliers", url: "https://roxiestreams.cc/nba-streams-3"},
  {title: "atlanta hawks vs brooklyn nets", url: "https://roxiestreams.cc/nba-streams-4"},
  {title: "golden state warriors vs los angeles clippers", url: "https://roxiestreams.cc/nba-streams-4"},
  {title: "nascar cup series - xfinity 500", url: "https://roxiestreams.cc/nascar"},
  {title: "formula 1 - mexico city grand prix", url: "https://roxiestreams.cc/f1-streams"},
  {title: "wwe nxt", url: "https://roxiestreams.cc/wwe-streams"},
  {title: "kansas city chiefs vs washington commanders", url: "https://roxiestreams.cc/nfl-streams-1"}
];

  const nbaTeams = new Set(["new orleans pelicans","los angeles lakers","oklahoma city thunder","washington wizards","minnesota timberwolves","philadelphia 76ers","golden state warriors","charlotte hornets","chicago bulls","portland trail blazers","boston celtics","orlando magic","dallas mavericks","memphis grizzlies","milwaukee bucks","phoenix suns","indiana pacers","toronto raptors","new york knicks","miami heat","utah jazz","houston rockets","detroit pistons","denver nuggets","sacramento kings","cleveland cavaliers","atlanta hawks","los angeles clippers","san antonio spurs"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

  function normalizeTeamName(name) {
    return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
  }

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

  const normalizedCache = roxieStreamsCached.map(item => ({
    title: normalizeTitle(item.title),
    url: item.url
  }));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.cc/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.cc/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.cc/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.cc/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.cc/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = channelName || 'Main';
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();
})();
