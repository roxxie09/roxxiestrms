(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "angers sco": "angers sco",
  "arsenal": "arsenal",
  "aston villa": "aston villa",
  "atlanta falcons": "atlanta falcons",
  "auxerre": "auxerre",
  "baltimore ravens": "baltimore ravens",
  "barcelona": "barcelona",
  "bears": "bears",
  "boston celtics": "boston celtics",
  "botafogo": "botafogo",
  "bournemouth": "bournemouth",
  "brooklyn spurs": "brooklyn spurs",
  "buffalo bills": "buffalo bills",
  "burnley": "burnley",
  "carolina panthers": "carolina panthers",
  "celta vigo": "celta vigo",
  "chicago": "chicago",
  "cincinnati bengals": "cincinnati bengals",
  "cleveland browns": "cleveland browns",
  "cleveland cavaliers": "cleveland cavaliers",
  "cruzeiro": "cruzeiro",
  "crystal palace": "crystal palace",
  "dallas cowboys": "dallas cowboys",
  "dallas mavericks": "dallas mavericks",
  "denver broncos": "denver broncos",
  "deportivo alavés": "deportivo alavés",
  "detroit hornets": "detroit hornets",
  "detroit pistons": "detroit pistons",
  "everton": "everton",
  "formula 1 - mexico city grand prix": "formula 1 - mexico city grand prix",
  "green bay packers": "green bay packers",
  "grêmio": "grêmio",
  "houston texans": "houston texans",
  "indiana pacers": "indiana pacers",
  "indianapolis colts": "indianapolis colts",
  "juventude": "juventude",
  "le havre": "le havre",
  "lens": "lens",
  "lille": "lille",
  "lorient": "lorient",
  "los angeles clippers": "los angeles clippers",
  "los angeles dodgers": "los angeles dodgers",
  "los angeles lakers": "los angeles lakers",
  "lyon": "lyon",
  "manchester city": "manchester city",
  "marseille": "marseille",
  "metz": "metz",
  "miami dolphins": "miami dolphins",
  "miami heat": "miami heat",
  "milwaukee bucks": "milwaukee bucks",
  "minnesota timberwolves": "minnesota timberwolves",
  "nascar cup series - xfinity 500": "nascar cup series - xfinity 500",
  "new england patriots": "new england patriots",
  "new orleans saints": "new orleans saints",
  "new york giants": "new york giants",
  "new york jets": "new york jets",
  "new york knicks": "new york knicks",
  "nfl redzone": "nfl redzone",
  "nice": "nice",
  "nottingham forest": "nottingham forest",
  "october 26, 2025 12:45 pm": "october 26, 2025 12:45 pm",
  "osasuna": "osasuna",
  "pachuca": "pachuca",
  "palmeiras": "palmeiras",
  "philadelphia eagles": "philadelphia eagles",
  "pittsburgh steelers": "pittsburgh steelers",
  "portland trail blazers": "portland trail blazers",
  "rayo vallecano": "rayo vallecano",
  "rb bragantino": "rb bragantino",
  "real madrid": "real madrid",
  "rennes": "rennes",
  "sacromento kings": "sacromento kings",
  "san antonio spurs": "san antonio spurs",
  "san francisco 49ers": "san francisco 49ers",
  "santos": "santos",
  "strasbourg": "strasbourg",
  "tampa bay buccaneers": "tampa bay buccaneers",
  "tennessee titans": "tennessee titans",
  "toluca": "toluca",
  "toronto blue jays": "toronto blue jays",
  "toronto raptors": "toronto raptors",
  "tottenham": "tottenham",
  "vasco da gama": "vasco da gama",
  "washington wizards": "washington wizards",
  "wolves": "wolves",
  "wwe raw": "wwe raw",
  "celtics": "boston celtics",
  "cavaliers": "cleveland cavaliers",
  "mavericks": "dallas mavericks",
  "pistons": "detroit pistons",
  "pacers": "indiana pacers",
  "clippers": "los angeles clippers",
  "lakers": "los angeles lakers",
  "heat": "miami heat",
  "bucks": "milwaukee bucks",
  "timberwolves": "minnesota timberwolves",
  "knicks": "new york knicks",
  "blazers": "portland trail blazers",
  "spurs": "san antonio spurs",
  "raptors": "toronto raptors",
  "wizards": "washington wizards"
};

  const roxieStreamsCached = [
  {title: "bournemouth vs nottingham forest", url: "https://roxiestreams.cc/soccer-streams-1"},
  {title: "aston villa vs manchester city", url: "https://roxiestreams.cc/soccer-streams-2"},
  {title: "arsenal vs crystal palace", url: "https://roxiestreams.cc/soccer-streams-3"},
  {title: "burnley vs wolves", url: "https://roxiestreams.cc/soccer-streams-4"},
  {title: "lille vs metz", url: "https://roxiestreams.cc/soccer-streams-5"},
  {title: "barcelona vs real madrid", url: "https://roxiestreams.cc/soccer-streams-6"},
  {title: "auxerre vs le havre", url: "https://roxiestreams.cc/soccer-streams-7"},
  {title: "nice vs rennes", url: "https://roxiestreams.cc/soccer-streams-5"},
  {title: "angers sco vs lorient", url: "https://roxiestreams.cc/soccer-streams-8"},
  {title: "everton vs tottenham", url: "https://roxiestreams.cc/soccer-streams-2"},
  {title: "celta vigo vs osasuna", url: "https://roxiestreams.cc/soccer-streams-9"},
  {title: "botafogo vs santos", url: "https://roxiestreams.cc/soccer-streams-10"},
  {title: "grêmio vs juventude", url: "https://roxiestreams.cc/soccer-streams-11"},
  {title: "lyon vs strasbourg", url: "https://roxiestreams.cc/soccer-streams-5"},
  {title: "lens vs marseille", url: "https://roxiestreams.cc/soccer-streams-5"},
  {title: "october 26, 2025 12:45 pm", url: "https://roxiestreams.cc/soccer-streams-12"},
  {title: "deportivo alavés vs rayo vallecano", url: "https://roxiestreams.cc/soccer-streams-9"},
  {title: "rb bragantino vs vasco da gama", url: "https://roxiestreams.cc/soccer-streams-10"},
  {title: "cruzeiro vs palmeiras", url: "https://roxiestreams.cc/soccer-streams-14"},
  {title: "pachuca vs toluca", url: "https://roxiestreams.cc/soccer-streams-15"},
  {title: "los angeles dodgers vs toronto blue jays", url: "https://roxiestreams.cc/mlb-streams-1"},
  {title: "brooklyn spurs vs san antonio spurs", url: "https://roxiestreams.cc/nba-streams-1"},
  {title: "boston celtics vs detroit pistons", url: "https://roxiestreams.cc/nba-streams-2"},
  {title: "cleveland cavaliers vs milwaukee bucks", url: "https://roxiestreams.cc/nba-streams-3"},
  {title: "detroit hornets vs washington wizards", url: "https://roxiestreams.cc/nba-streams-4"},
  {title: "miami heat vs new york knicks", url: "https://roxiestreams.cc/nba-streams-5"},
  {title: "indiana pacers vs minnesota timberwolves", url: "https://roxiestreams.cc/nba-streams-6"},
  {title: "dallas mavericks vs toronto raptors", url: "https://roxiestreams.cc/nba-streams-7"},
  {title: "los angeles lakers vs sacromento kings", url: "https://roxiestreams.cc/nba-streams-8"},
  {title: "los angeles clippers vs portland trail blazers", url: "https://roxiestreams.cc/nba-streams-9"},
  {title: "nascar cup series - xfinity 500", url: "https://roxiestreams.cc/nascar"},
  {title: "formula 1 - mexico city grand prix", url: "https://roxiestreams.cc/f1-streams"},
  {title: "wwe raw", url: "https://roxiestreams.cc/wwe-streams"},
  {title: "nfl redzone", url: "https://roxiestreams.cc/redzone"},
  {title: "houston texans vs san francisco 49ers", url: "https://roxiestreams.cc/nfl-streams-1"},
  {title: "baltimore ravens vs bears vs chicago", url: "https://roxiestreams.cc/nfl-streams-2"},
  {title: "buffalo bills vs carolina panthers", url: "https://roxiestreams.cc/nfl-streams-3"},
  {title: "cleveland browns vs new england patriots", url: "https://roxiestreams.cc/nfl-streams-4"},
  {title: "atlanta falcons vs miami dolphins", url: "https://roxiestreams.cc/nfl-streams-5"},
  {title: "new york giants vs philadelphia eagles", url: "https://roxiestreams.cc/nfl-streams-6"},
  {title: "cincinnati bengals vs new york jets", url: "https://roxiestreams.cc/nfl-streams-7"},
  {title: "new orleans saints vs tampa bay buccaneers", url: "https://roxiestreams.cc/nfl-streams-8"},
  {title: "dallas cowboys vs denver broncos", url: "https://roxiestreams.cc/nfl-streams-9"},
  {title: "indianapolis colts vs tennessee titans", url: "https://roxiestreams.cc/nfl-streams-10"},
  {title: "green bay packers vs pittsburgh steelers", url: "https://roxiestreams.cc/nfl-streams-11"}
];

  const nbaTeams = new Set(["dallas mavericks","new orleans pelicans","indiana pacers","philadelphia 76ers","new york knicks","portland trail blazers","milwaukee bucks","chicago bulls","los angeles lakers","boston celtics","atlanta hawks","denver nuggets","utah jazz","miami heat","san antonio spurs","toronto raptors","charlotte hornets","golden state warriors","sacramento kings","los angeles clippers","phoenix suns","cleveland cavaliers","detroit pistons","memphis grizzlies","houston rockets","minnesota timberwolves","washington wizards","orlando magic","oklahoma city thunder"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

  function normalizeTeamName(name) {
    return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
  }

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

  const normalizedCache = roxieStreamsCached.map(item => ({
    title: normalizeTitle(item.title),
    url: item.url
  }));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.cc/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.cc/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.cc/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.cc/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.cc/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = channelName || 'Main';
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();
})();
