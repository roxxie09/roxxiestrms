(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "angers sco": "angers sco",
  "arizona": "arizona",
  "arizona state": "arizona state",
  "arkansas": "arkansas",
  "atlanta falcons": "atlanta falcons",
  "atlanta hawks": "atlanta hawks",
  "auburn": "auburn",
  "bahia": "bahia",
  "barcelona": "barcelona",
  "boca juniors": "boca juniors",
  "boise state": "boise state",
  "boston college": "boston college",
  "bournemouth": "bournemouth",
  "bragantino": "bragantino",
  "brest": "brest",
  "brooklyn nets": "brooklyn nets",
  "buffallo bills": "buffallo bills",
  "california": "california",
  "carolina panthers": "carolina panthers",
  "ceará": "ceará",
  "celta vigo": "celta vigo",
  "celtic": "celtic",
  "central michigan": "central michigan",
  "charlotte hornets": "charlotte hornets",
  "chicago bears": "chicago bears",
  "chicago bulls": "chicago bulls",
  "chivas": "chivas",
  "cincinnati": "cincinnati",
  "cincinnati bengals": "cincinnati bengals",
  "cleveland cavaliers": "cleveland cavaliers",
  "colorado": "colorado",
  "corinthians": "corinthians",
  "delaware": "delaware",
  "denver broncos": "denver broncos",
  "deportivo alavés": "deportivo alavés",
  "detroit lions": "detroit lions",
  "east": "east",
  "elche": "elche",
  "espanyol": "espanyol",
  "estudiantes": "estudiantes",
  "florida": "florida",
  "florida state": "florida state",
  "fluminense": "fluminense",
  "fresno state": "fresno state",
  "georgia": "georgia",
  "georgia tech": "georgia tech",
  "gimnasia la plata": "gimnasia la plata",
  "green bay packers": "green bay packers",
  "grêmio": "grêmio",
  "hawaii": "hawaii",
  "hellas verona": "hellas verona",
  "houston texans": "houston texans",
  "indiana": "indiana",
  "indianapolis colts": "indianapolis colts",
  "inter milan": "inter milan",
  "jacksonville jaguars": "jacksonville jaguars",
  "juventude": "juventude",
  "kansas chiefs": "kansas chiefs",
  "kansas state": "kansas state",
  "kentucky": "kentucky",
  "las vegas raiders": "las vegas raiders",
  "lens": "lens",
  "levante": "levante",
  "liberty": "liberty",
  "lille": "lille",
  "lorient": "lorient",
  "los angeles chargers": "los angeles chargers",
  "los angeles dodgers": "los angeles dodgers",
  "los angeles lakers": "los angeles lakers",
  "los angeles rams": "los angeles rams",
  "lyon": "lyon",
  "manchester city": "manchester city",
  "maryland": "maryland",
  "mazatlán": "mazatlán",
  "memphis grizzlies": "memphis grizzlies",
  "miami heat": "miami heat",
  "milan": "milan",
  "minnesota vikings": "minnesota vikings",
  "mississippi state": "mississippi state",
  "nascar xfinity series - race": "nascar xfinity series - race",
  "nc state": "nc state",
  "nebraska": "nebraska",
  "new england patriots": "new england patriots",
  "new orleans pelicans": "new orleans pelicans",
  "new orleans saints": "new orleans saints",
  "new york giants": "new york giants",
  "new york knicks": "new york knicks",
  "newcastle": "newcastle",
  "notre dame": "notre dame",
  "oklahoma": "oklahoma",
  "oklahoma city thunder": "oklahoma city thunder",
  "ole miss": "ole miss",
  "onama": "onama",
  "oregon state": "oregon state",
  "pachuca": "pachuca",
  "palmeiras": "palmeiras",
  "philadelphia 76ers": "philadelphia 76ers",
  "phoenix suns": "phoenix suns",
  "pitt": "pitt",
  "pittsburgh steelers": "pittsburgh steelers",
  "pumas unam": "pumas unam",
  "querétaro": "querétaro",
  "rangers": "rangers",
  "rennes": "rennes",
  "river plate": "river plate",
  "roma": "roma",
  "san antonio spurs": "san antonio spurs",
  "san diego state": "san diego state",
  "san fransico 49ers": "san fransico 49ers",
  "san jose state": "san jose state",
  "seattle seahawks": "seattle seahawks",
  "south carolina": "south carolina",
  "stanford": "stanford",
  "strasbourg": "strasbourg",
  "são paulo": "são paulo",
  "tennessee": "tennessee",
  "tennessee titans": "tennessee titans",
  "texas tech": "texas tech",
  "tijuana": "tijuana",
  "toronto blue jays": "toronto blue jays",
  "toronto raptors": "toronto raptors",
  "troy": "troy",
  "ufc vegas 110: garcia": "ufc vegas 110: garcia",
  "usc": "usc",
  "utah": "utah",
  "utah jazz": "utah jazz",
  "vasco da gama": "vasco da gama",
  "virginia": "virginia",
  "wake forest": "wake forest",
  "washington commanders": "washington commanders",
  "washington state": "washington state",
  "west 20": "west 20",
  "west ham": "west ham",
  "western michigan": "western michigan",
  "wwe raw": "wwe raw",
  "wwe saturday night's main event": "wwe saturday night's main event",
  "wyoming": "wyoming",
  "hawks": "atlanta hawks",
  "hornets": "charlotte hornets",
  "bulls": "chicago bulls",
  "cavaliers": "cleveland cavaliers",
  "lakers": "los angeles lakers",
  "grizzlies": "memphis grizzlies",
  "heat": "miami heat",
  "pelicans": "new orleans pelicans",
  "knicks": "new york knicks",
  "thunder": "oklahoma city thunder",
  "sixers": "philadelphia 76ers",
  "suns": "phoenix suns",
  "spurs": "san antonio spurs",
  "raptors": "toronto raptors",
  "jazz": "utah jazz"
};

  const roxieStreamsCached = [
  {title: "hellas verona vs inter milan", url: "https://roxiestreams.cc/soccer-streams-1"},
  {title: "celta vigo vs levante", url: "https://roxiestreams.cc/soccer-streams-2"},
  {title: "newcastle vs west ham", url: "https://roxiestreams.cc/soccer-streams-3"},
  {title: "rennes vs strasbourg", url: "https://roxiestreams.cc/soccer-streams-4"},
  {title: "celtic vs rangers", url: "https://roxiestreams.cc/soccer-streams-1"},
  {title: "deportivo alavés vs espanyol", url: "https://roxiestreams.cc/soccer-streams-2"},
  {title: "lens vs lorient", url: "https://roxiestreams.cc/soccer-streams-5"},
  {title: "angers sco vs lille", url: "https://roxiestreams.cc/soccer-streams-4"},
  {title: "bournemouth vs manchester city", url: "https://roxiestreams.cc/soccer-streams-3"},
  {title: "barcelona vs elche", url: "https://roxiestreams.cc/soccer-streams-2"},
  {title: "pumas unam vs tijuana", url: "https://roxiestreams.cc/soccer-streams-6"},
  {title: "corinthians vs grêmio", url: "https://roxiestreams.cc/soccer-streams-7"},
  {title: "bahia vs bragantino", url: "https://roxiestreams.cc/soccer-streams-8"},
  {title: "boca juniors vs estudiantes", url: "https://roxiestreams.cc/soccer-streams-9"},
  {title: "ceará vs fluminense", url: "https://roxiestreams.cc/soccer-streams-7"},
  {title: "milan vs roma", url: "https://roxiestreams.cc/soccer-streams-10"},
  {title: "brest vs lyon", url: "https://roxiestreams.cc/soccer-streams-4"},
  {title: "juventude vs palmeiras", url: "https://roxiestreams.cc/soccer-streams-7"},
  {title: "mazatlán vs querétaro", url: "https://roxiestreams.cc/soccer-streams-11"},
  {title: "são paulo vs vasco da gama", url: "https://roxiestreams.cc/soccer-streams-7"},
  {title: "gimnasia la plata vs river plate", url: "https://roxiestreams.cc/soccer-streams-9"},
  {title: "chivas vs pachuca", url: "https://roxiestreams.cc/soccer-streams-12"},
  {title: "los angeles dodgers vs toronto blue jays", url: "https://roxiestreams.cc/mlb-streams-1"},
  {title: "new orleans pelicans vs oklahoma city thunder", url: "https://roxiestreams.cc/nba-streams-1"},
  {title: "memphis grizzlies vs toronto raptors", url: "https://roxiestreams.cc/nba-streams-2"},
  {title: "atlanta hawks vs cleveland cavaliers", url: "https://roxiestreams.cc/nba-streams-3"},
  {title: "brooklyn nets vs philadelphia 76ers", url: "https://roxiestreams.cc/nba-streams-4"},
  {title: "charlotte hornets vs utah jazz", url: "https://roxiestreams.cc/nba-streams-5"},
  {title: "chicago bulls vs new york knicks", url: "https://roxiestreams.cc/nba-streams-6"},
  {title: "phoenix suns vs san antonio spurs", url: "https://roxiestreams.cc/nba-streams-7"},
  {title: "los angeles lakers vs miami heat", url: "https://roxiestreams.cc/nba-streams-8"},
  {title: "nascar xfinity series - race", url: "https://roxiestreams.cc/nascar"},
  {title: "east vs west 20", url: "https://roxiestreams.cc/ppv-streams-1"},
  {title: "onama vs ufc vegas 110: garcia", url: "https://roxiestreams.cc/ufc"},
  {title: "wwe saturday night's main event", url: "https://roxiestreams.cc/wwe-streams"},
  {title: "wwe raw", url: "https://roxiestreams.cc/wwe-streams"},
  {title: "new york giants vs san fransico 49ers", url: "https://roxiestreams.cc/nfl-streams-1"},
  {title: "los angeles chargers vs tennessee titans", url: "https://roxiestreams.cc/nfl-streams-2"},
  {title: "detroit lions vs minnesota vikings", url: "https://roxiestreams.cc/nfl-streams-3"},
  {title: "atlanta falcons vs new england patriots", url: "https://roxiestreams.cc/nfl-streams-4"},
  {title: "indianapolis colts vs pittsburgh steelers", url: "https://roxiestreams.cc/nfl-streams-5"},
  {title: "denver broncos vs houston texans", url: "https://roxiestreams.cc/nfl-streams-6"},
  {title: "chicago bears vs cincinnati bengals", url: "https://roxiestreams.cc/nfl-streams-7"},
  {title: "carolina panthers vs green bay packers", url: "https://roxiestreams.cc/nfl-streams-8"},
  {title: "los angeles rams vs new orleans saints", url: "https://roxiestreams.cc/nfl-streams-9"},
  {title: "jacksonville jaguars vs las vegas raiders", url: "https://roxiestreams.cc/nfl-streams-10"},
  {title: "buffallo bills vs kansas chiefs", url: "https://roxiestreams.cc/nfl-streams-11"},
  {title: "seattle seahawks vs washington commanders", url: "https://roxiestreams.cc/nfl-streams-12"},
  {title: "pitt vs stanford", url: "https://roxiestreams.cc/nfl-streams-4"},
  {title: "boise state vs fresno state", url: "https://roxiestreams.cc/ncaa-streams-2"},
  {title: "delaware vs liberty", url: "https://roxiestreams.cc/ncaa-streams-9"},
  {title: "kansas state vs texas tech", url: "https://roxiestreams.cc/ncaa-streams-3"},
  {title: "indiana vs maryland", url: "https://roxiestreams.cc/ncaa-streams-8"},
  {title: "florida vs georgia", url: "https://roxiestreams.cc/ncaa-streams-6"},
  {title: "oregon state vs washington state", url: "https://roxiestreams.cc/ncaa-streams-8"},
  {title: "boston college vs notre dame", url: "https://roxiestreams.cc/ncaa-streams-5"},
  {title: "california vs virginia", url: "https://roxiestreams.cc/ncaa-streams-7"},
  {title: "central michigan vs western michigan", url: "https://roxiestreams.cc/ncaa-streams-1"},
  {title: "arkansas vs mississippi state", url: "https://roxiestreams.cc/ncaa-streams-13"},
  {title: "san diego state vs wyoming", url: "https://roxiestreams.cc/ncaa-streams-9"},
  {title: "arizona vs colorado", url: "https://roxiestreams.cc/ncaa-streams-2"},
  {title: "ole miss vs south carolina", url: "https://roxiestreams.cc/ncaa-streams-5"},
  {title: "nebraska vs usc", url: "https://roxiestreams.cc/ncaa-streams-10"},
  {title: "oklahoma vs tennessee", url: "https://roxiestreams.cc/ncaa-streams-6"},
  {title: "auburn vs kentucky", url: "https://roxiestreams.cc/ncaa-streams-13"},
  {title: "florida state vs wake forest", url: "https://roxiestreams.cc/ncaa-streams-4"},
  {title: "georgia tech vs nc state", url: "https://roxiestreams.cc/ncaa-streams-7"},
  {title: "arizona state vs troy", url: "https://roxiestreams.cc/ncaa-streams-1"},
  {title: "cincinnati vs utah", url: "https://roxiestreams.cc/ncaa-streams-5"},
  {title: "hawaii vs san jose state", url: "https://roxiestreams.cc/ncaa-streams-9"}
];

  const nbaTeams = new Set(["los angeles lakers","sacramento kings","phoenix suns","boston celtics","houston rockets","portland trail blazers","minnesota timberwolves","new orleans pelicans","atlanta hawks","denver nuggets","toronto raptors","oklahoma city thunder","detroit pistons","memphis grizzlies","washington wizards","philadelphia 76ers","charlotte hornets","los angeles clippers","golden state warriors","cleveland cavaliers","orlando magic","chicago bulls","dallas mavericks","milwaukee bucks","san antonio spurs","miami heat","utah jazz","new york knicks","indiana pacers"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

function normalizeTeamName(name) {
  return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
}

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

const normalizedCache = roxieStreamsCached.map(item => ({
  title: normalizeTitle(item.title),
  url: item.url
}));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.cc/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.cc/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.cc/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.cc/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.cc/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add.modal-trigger'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-target');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 400)); // Wait for autofill

      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }
      const urlInput = form.querySelector('#url');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }
      const urlValue = urlInput.value.trim();

      // SKIP modals/events whose URL is "missing"
      if (urlValue === 'https://roxiestreams.cc/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        // Optionally: You may wish to close the modal here so it doesn't remain open, OR ignore and let user close after
        // If you want to close, uncomment below:
        // const closeBtn = document.querySelector(`#submit-${gameId}`);
        // if (closeBtn) closeBtn.click();
        await new Promise(res => setTimeout(res, 400));
        continue;
      }

      // Valid URL found, click external submit button to save/close
      const submitBtn = document.querySelector(`#submit-${gameId}`);
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked external submit button for ${gameId}`);
      } else if (form) {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }
      await new Promise(res => setTimeout(res, 400));
    }
  }

  // Start automated modal processing
  autoProcessAllEvents();

  // For manual reruns, expose to window
  window.autoProcessAllEvents = autoProcessAllEvents;
})();
